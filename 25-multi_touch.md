<!--
 * @Date: 2024-12-29
 * @LastEditors: GoKo-Son626
 * @LastEditTime: 2024-12-30
 * @FilePath: /1-STM32MP157/25-multi_touch.md
 * @Description: 
-->
# multi_touch

> ATK7016 这款 RGB LCD 屏幕为例讲解一下如何驱动电容触摸屏，并获取对应的触摸坐标值

### 1. 多点电容触摸

- TK-7016 这款屏幕其实是由 TFT LCD+触摸屏组合起来的。底下是 LCD 面板，上面是触摸面板，将两个封装到一起就成了带有触摸屏的 LCD 屏幕。电容触摸屏也是需要一个驱动 IC的，驱动 IC 一般会提供一个 I2C 接口给主控制器，主控制器可以通过 I2C 接口来读取驱动 IC里面的触摸坐标数据。ATK-7016、ATK-7084 这两款屏幕使用的触摸控制 IC 是 FT5426，ATK-4342 使用的驱动 IC 是 GT9147。这三个电容屏触摸 IC 都是 I2C 接口的，使用方法基本一样。
- FT5426 这款驱动 IC 采用 15*28 的驱动结构，也就是 15 个感应通道，28 个驱动通道，最
多支持 5 点电容触摸。ATK-7016 的电容触摸屏部分有 4 个 IO 用于连接主控制器：SCL、SDA、
RST 和 INT，SCL 和 SDA 是 I2C 引脚，RST 是复位引脚，INT 是中断引脚。一般通过 INT 引
脚来通知主控制器有触摸点按下，然后在 INT 中断服务函数中读取触摸数据。也可以不使用中
断功能，采用轮询的方式不断查询是否有触摸点按下，本章实验我们使用中断方式来获取触摸
数据。
跟所有的 I2C 器件一样，FT5426 也是通过读写寄存器来完成初始化和触摸坐标数据读取
的，STM32MP1 的 I2C 我们已经在第四十章做了详细的讲解，所以本章的主要工作就是读写
FT5426 的寄存器。FT5426 的 I2C 设备地址为 0X38，FT5426 的寄存器有很多，本章我们只用
到了其中的一部分，如表

### 2. Linux下电容触摸屏驱动框架

##### 1. 多点触摸(MT)协议详解
电容触摸驱动的基本原理进行了详细的讲解，回顾一下几个重要的知识点：
- 电容触摸屏是 IIC 接口的，需要触摸 IC，以正点原子的 ATK7016 为例，其所使用的触摸屏控制 IC 为 FT5426，因此所谓的电容触摸驱动就是 IIC 设备驱动。
- 触摸 IC 提供了中断信号引脚(INT)，可以通过中断来获取触摸信息。
- 电容触摸屏得到的是触摸位置绝对信息以及触摸屏是否有按下。
- 电容触摸屏不需要校准，当然了，这只是理论上的，如果电容触摸屏质量比较差，或者触摸玻璃和 TFT 之间没有完全对齐，那么也是需要校准的。

**MT协议被分为两种类型:**
TypeA 和 TypeB，这两种类型的区别如下：
Type A：适用于触摸点不能被区分或者追踪，此类型的设备上报原始数据(此类型在实际使
用中非常少！)。
Type B：适用于有硬件追踪并能区分触摸点的触摸设备，此类型设备通过 slot 更新某一个
触摸点的信息，FT5426 就属于此类型，一般的多点电容触摸屏 IC 都有此能力

不管是哪个类型的设备，最终都要调用 input_sync()函数来标识多点触摸信息传输完成，告
诉接收者处理之前累计的所有消息，并且准备好下一次接收。Type B 和 Type A 相比最大的区
别就是 Type B 可以区分出触摸点， 因此可以减少发送到用户空间的数据。Type B 使用 slot 协
议区分具体的触摸点，slot 需要用到 ABS_MT_TRACKING_ID 消息，这个 ID 需要硬件提供，
或者通过原始数据计算出来。对于 Type A 设备，内核驱动需要一次性将触摸屏上所有的触摸点
信息全部上报，每个触摸点的信息在本次上报事件流中的顺序不重要，因为事件的过滤和手指
(触摸点)跟踪是在内核空间处理的。

##### 2. TypeA类型触摸点信息上报时序
```c
1 ABS_MT_POSITION_X x[0]
2 ABS_MT_POSITION_Y y[0]
3 SYN_MT_REPORT
4 ABS_MT_POSITION_X x[1]
5 ABS_MT_POSITION_Y y[1]
6 SYN_MT_REPORT

7 SYN_REPORT    
```
##### 3. TypeB类型触摸点信息上报时序
```c
1 ABS_MT_SLOT 0
2 ABS_MT_TRACKING_ID 45
3 ABS_MT_POSITION_X x[0]
4 ABS_MT_POSITION_Y y[0]
5 ABS_MT_SLOT 1
6 ABS_MT_TRACKING_ID 46
7 ABS_MT_POSITION_X x[1]
8 ABS_MT_POSITION_Y y[1]
9 SYN_REPORT
```
##### 4. 多点电容触摸驱动框架
前面已经详细的讲解了 linux 下多点触摸屏驱动原理，本小节我们来梳理一下 linux
下多点电容触摸驱动的编写框架和步骤。首先确定驱动需要用到哪些知识点，哪些框架？
根据前面的分析，我们在编写驱动的时候需要注意一下几点：
①、多点电容触摸芯片的接口，一般都为 I2C 接口，因此驱动主框架肯定是 I2C。
②、linux 里面一般都是通过中断来上报触摸点坐标信息，因此需要用到中断框架。
③、多点电容触摸属于 input 子系统，因此还要用到 input 子系统框架。
④、在中断处理程序中按照 linux 的 MT 协议上报坐标信息。
根据上面的分析，多点电容触摸驱动编写框架以及步骤如下：
初始化触摸 IC、中断和 input 子系统

1. I2C驱动框架
2. 初始化触摸 IC、中断和 input 子系统
为什么中断线程化(devm_request_threaded_irq)：
        硬件中断具有最高优先级，不论什么时
候只要硬件中断发生，那么内核都会终止当前正在执行的操作，转而去执行中断处理程序(不考
虑关闭中断和中断优先级的情况)，如果中断非常频繁的话那么内核将会频繁的执行中断处理程
序，导致任务得不到及时的处理。中断线程化以后中断将作为内核线程运行，而且也可以被赋
予不同的优先级，任务的优先级可能比中断线程的优先级高，这样做的目的就是保证高优先级
的任务能被优先处理
        使用“devm_”前缀的函数申请到的资源可以由系统自动释放，不需要我们手动处理。
3. 上报坐标信息

